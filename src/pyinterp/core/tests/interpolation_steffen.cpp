// Copyright (c) 2024 CNES
//
// All rights reserved. Use of this source code is governed by a
// BSD-style license that can be found in the LICENSE file.
#include <gtest/gtest.h>

#include "pyinterp/detail/interpolation/steffen.hpp"

TEST(Steffen, case_one) {
  Eigen::Matrix<double, Eigen::Dynamic, 1> xa(5);
  Eigen::Matrix<double, Eigen::Dynamic, 1> ya(5);
  Eigen::Matrix<double, Eigen::Dynamic, 1> xp(6);
  Eigen::Matrix<double, Eigen::Dynamic, 1> yp(6);
  Eigen::Matrix<double, Eigen::Dynamic, 1> dyp(6);

  xa << 0.0, 1.0, 2.0, 3.0, 4.0;
  ya << 0.0, 1.0, 2.0, 3.0, 4.0;
  xp << 0.0, 0.5, 1.0, 2.0, 2.5, 3.95;
  yp << 0.0, 0.5, 1.0, 2.0, 2.5, 3.95;
  dyp << 1.0, 1.0, 1.0, 1.0, 1.0, 1.0;

  auto interpolator = pyinterp::detail::interpolation::Steffen<double>();
  auto y = interpolator(xa, ya, xp);
  for (auto ix = 0; ix < xp.size(); ix++) {
    EXPECT_NEAR(y(ix), yp(ix), 1e-6);
  }

  auto dy = interpolator.derivative(xa, ya, xp);
  for (auto ix = 0; ix < xp.size(); ix++) {
    EXPECT_NEAR(dy(ix), dyp(ix), 1e-6);
  }
}

TEST(Steffen, case_two) {
  Eigen::Matrix<double, Eigen::Dynamic, 1> xa(30);
  Eigen::Matrix<double, Eigen::Dynamic, 1> ya(30);
  Eigen::Matrix<double, Eigen::Dynamic, 1> xp(129);
  Eigen::Matrix<double, Eigen::Dynamic, 1> yp(129);
  Eigen::Matrix<double, Eigen::Dynamic, 1> dyp(129);

  xa << 4.673405471947611, 4.851675778029557, 6.185473620119991,
      7.066003430727031, 7.236222118389267, 7.82067161881444, 8.054504031621493,
      8.615033792800752, 9.16666529764867, 9.442092828126395,
      10.719577968900381, 11.741967577609238, 12.564881194673035,
      12.938424721515084, 12.985892202096888, 13.995771653255744,
      14.459157783380315, 15.834857667614848, 15.887779086499942,
      18.64645279534696, 19.256361741244287, 19.85100457105047,
      19.943627313550987, 20.5033910115468, 20.895380493234843,
      21.759942483053962, 21.948984866760803, 22.2504057728461,
      22.741860290952104, 23.088720630939164;

  ya << -6.131584089652438, 4.997132870704837, 9.50359639889188,
      -3.788474042493764, 1.98825324341826, -6.553460294945401,
      8.44565760012345, -3.643687601520438, -4.720262269613782,
      -5.31956608504474, 4.7484698519996655, 1.8191111043001218,
      2.7234424260251124, -7.282776099988966, -6.966038807035955,
      2.6047260012112545, -3.6363485275348033, -4.124714595822157,
      -4.820986899771757, -2.8550035950284602, 6.017204757558943,
      6.7275899382734075, -9.423359755713639, -0.3645325139870703,
      6.925739188986089, -0.07843256857855074, 1.6744315603866244,
      -8.332083151442944, 6.059246349756446, -7.360159198725659;

  xp << 4.6734054719476106, 4.8516757780295574, 4.8575586235375265,
      5.0417117751274407, 5.2258649267173567, 5.4100180783072727,
      5.5941712298971886, 5.7783243814871028, 5.9624775330770188,
      6.1466306846669347, 6.1854736201199909, 6.3307838362568507,
      6.5149369878467667, 6.6990901394366809, 6.8832432910265968,
      7.0660034307270312, 7.0673964426165128, 7.236222118389267,
      7.2515495942064288, 7.4357027457963438, 7.6198558973862589,
      7.8040090489761749, 7.8206716188144396, 7.9881622005660908,
      8.0545040316214926, 8.172315352156005, 8.356468503745921,
      8.5406216553358369, 8.6150337928007517, 8.7247748069257529,
      8.9089279585156689, 9.0930811101055831, 9.1666652976486702,
      9.277234261695499, 9.4420928281263947, 9.461387413285415,
      9.645540564875331, 9.8296937164652469, 10.013846868055161,
      10.198000019645077, 10.382153171234993, 10.566306322824907,
      10.719577968900381, 10.750459474414823, 10.934612626004739,
      11.118765777594655, 11.302918929184571, 11.487072080774485,
      11.671225232364399, 11.741967577609238, 11.855378383954315,
      12.039531535544231, 12.223684687134147, 12.407837838724063,
      12.564881194673035, 12.591990990313979, 12.776144141903895,
      12.938424721515084, 12.960297293493811, 12.985892202096888,
      13.144450445083727, 13.328603596673641, 13.512756748263556,
      13.696909899853472, 13.881063051443387, 13.995771653255744,
      14.065216203033303, 14.249369354623219, 14.433522506213134,
      14.459157783380315, 14.617675657803051, 14.801828809392966,
      14.985981960982881, 15.170135112572796, 15.354288264162712,
      15.538441415752628, 15.722594567342544, 15.834857667614848,
      15.90674771893246, 15.887779086499942, 16.090900870522375,
      16.27505402211229, 16.459207173702204, 16.643360325292122,
      16.827513476882036, 17.01166662847195, 17.195819780061868,
      17.379972931651782, 17.5641260832417, 17.748279234831614,
      17.932432386421532, 18.116585538011446, 18.300738689601364,
      18.484891841191278, 18.64645279534696, 18.669044992781188,
      18.853198144371106, 19.03735129596102, 19.221504447550938,
      19.256361741244287, 19.405657599140852, 19.58981075073077,
      19.773963902320684, 19.851004571050471, 19.958117053910598,
      19.943627313550987, 20.142270205500516, 20.32642335709043,
      20.5033910115468, 20.510576508680348, 20.694729660270262,
      20.87888281186018, 20.895380493234843, 21.063035963450094,
      21.247189115040012, 21.431342266629926, 21.61549541821984,
      21.759942483053962, 21.799648569809754, 21.948984866760803,
      21.983801721399669, 22.167954872989586, 22.250405772846101,
      22.352108024579501, 22.536261176169418, 22.720414327759332,
      22.741860290952104, 22.90456747934925, 23.088720630939164;
  yp << -6.1315840896524376, 4.9971328707048368, 5.0367975988827167,
      6.1897906340782765, 7.170975366812117, 7.9803517970842286,
      8.6179199248946077, 9.083679750243256, 9.3776312731301772,
      9.4997744935553676, 9.5035963988918795, 8.5371013292095554,
      5.3135045284256019, 1.2120062346303317, -2.3083133782071208,
      -3.788474042493764, -3.7873197326712797, 1.98825324341826,
      1.9709370138809248, -0.31768851396215103, -4.2211558425051745,
      -6.5330277558649303, -6.5534602949454008, 5.5087083141507147,
      8.4456576001234502, 7.1443430435268214, 1.9932653799771245,
      -2.8426372908118083, -3.6436876015204378, -3.9926784426485034,
      -4.3315242293057175, -4.5849882013553547, -4.7202622696137819,
      -5.0157009305506106, -5.3195660850447402, -5.3127453670702938,
      -4.6348437675141847, -3.1014810884327102, -1.0745634258401102,
      1.0840031242494419, 3.0123124658217071, 4.3484585028624627,
      4.7484698519996655, 4.740613456600772, 4.4142234654988952,
      3.7574719541934956, 2.9757785771330334, 2.274562988765974,
      1.8592448435407634, 1.8191111043001218, 1.8659054809992697,
      2.0883298868527498, 2.3859686670095699, 2.6372078307738107,
      2.7234424260251124, 2.5729816013335247, -3.258105131647655,
      -7.2827760999889657, -7.179945071809863, -6.9660388070359547,
      -5.5662805880783406, -3.3905902235190721, -1.0497645733987406,
      1.0095869363327665, 2.3408548797255095, 2.6047260012112545,
      2.2325150500282476, -0.91241316251151927, -3.5649171021138555,
      -3.6363485275348033, -3.7309363021244821, -3.8038342533632736,
      -3.8503835649797429, -3.8846412514674595, -3.920664327319995,
      -3.9725098070309213, -4.0542347050938083, -4.1247145958221569,
      -4.8208939493861829, -4.8209868997717571, -4.8103284962540727,
      -4.7822416973267625, -4.7366335526042516, -4.6735040620865389,
      -4.5928532257736272, -4.4946810436655156, -4.3789875157622005,
      -4.2457726420636881, -4.0950364225699714, -3.9267788572810582,
      -3.7409999461969403, -3.537699689317626, -3.3168780866431069,
      -3.0785351381733914, -2.8550035950284602, -2.7914506045621672,
      -0.46968123806956008, 3.263658433044764, 5.8622198554846658,
      6.0172047575589431, 6.3291356295622618, 6.5905310151592165,
      6.7156659481449141, 6.7275899382734075, -9.4118959280855066,
      -9.4233597557136388, -7.6111870705157543, -3.9651685725226056,
      -0.36453251398707032, -0.23537781181431175, 4.0332797539781309,
      6.899794364641159, 6.9257391889860891, 6.2377210430025594,
      4.3902665602806792, 2.1878722453596344, 0.44278317319805183,
      -0.078432568578550743, 0.12107113682074738, 1.6744315603866244,
      1.3047436323966959, -6.4955024539509765, -8.3320831514429443,
      -6.7382472104931805, 0.61052993339902706, 5.9794239504090552,
      6.0592463497564459, 1.5387265272596853, -7.3601591987256612;
  dyp << 62.426083204466224, 6.757341159173202, 6.727537246743899,
      5.7945730211610407, 4.8616087955781726, 3.9286445699953054,
      2.9956803444124378, 2.0627161188295791, 1.1297518932467119,
      0.1967876676638447, 0, -12.480296842307126, -21.209126982426163,
      -22.014768399615317, -14.897221093874615, 0, 1.65274069980919, 0,
      -2.2393981239975669, -19.714311699236049, -19.77742868994725,
      -2.4287490961310456, 0, 78.213312807624717, 0, -20.358420305108574,
      -31.350476855816961, -16.93545425712459, -3.9032385156832157,
      -2.5401833171916435, -1.3740294011308083, -1.6128919418291603,
      -2.1012124848241789, -2.8800570317456784, 0, 0.70341285683675259,
      6.3314138906742139, 9.9941697310971538, 11.69168037810557,
      11.42394583169949, 9.1909660918788916, 4.992741158643824, 0,
      -0.50358091648162351, -2.8552721239834269, -4.0914806331173992,
      -4.2122064438835425, -3.2174495562818706, -1.1072099703123885, 0,
      0.78347408424733667, 1.5221058615312819, 1.6003417148468082,
      1.018181644193916, 0, -10.817925943273289, -39.490030870551372, 0,
      8.0126635338650072, 6.7986203849007927, 10.557804177353285,
      12.667135433334296, 12.351260158262027, 9.6101783521364421,
      4.44389001495753, 0, -10.1306309231183, -19.882866043398995,
      -4.7826445467139278, -0.70998925548225966, -0.49283947499262398,
      -0.31159279753453034, -0.20667940230488324, -0.17809928930368468,
      -0.22585245853093405, -0.3499389099866323, -0.55035864367077902,
      -0.70998925548225966, 0.0098004308855327432, 0, 0.10494594234665755,
      0.20009145380778143, 0.2952369652689053, 0.39038247673003107,
      0.48552798819115495, 0.58067349965227877, 0.67581901111340459,
      0.77096452257452841, 0.86611003403565412, 0.96125554549677805,
      1.0564010569579039, 1.1515465684190276, 1.2466920798801533,
      1.3418375913412772, 1.4253105022449177, 4.1661049863071913,
      18.74497348837053, 19.496500284294363, 6.4206853740787171,
      2.3892836005304425, 1.7894106566060179, 1.0494805960296585,
      0.30955053545331346, 0, 1.5724451183167569, 0, 16.386389851530527,
      21.613477536080744, 17.603560096681914, 18.338573561497682,
      23.697110333020628, 3.1105642331329868, 0, -7.5982202651552164,
      -11.73098890423519, -11.453053366134201, -6.7644136508523696, 0,
      9.2309078320594402, 0, -20.350273706124355, -39.581660196515507, 0,
      28.835095151183879, 42.753317235684989, 7.3325239511975031, 0,
      -47.053315974301256, -38.688209637869583;

  auto interpolator = pyinterp::detail::interpolation::Steffen<double>();
  auto y = interpolator(xa, ya, xp);
  for (auto ix = 0; ix < xp.size(); ix++) {
    EXPECT_NEAR(y(ix), yp(ix), 1e-6);
  }

  auto dy = interpolator.derivative(xa, ya, xp);
  for (auto ix = 0; ix < xp.size(); ix++) {
    EXPECT_NEAR(dy(ix), dyp(ix), 1e-6);
  }
}
